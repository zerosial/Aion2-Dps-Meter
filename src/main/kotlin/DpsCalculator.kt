package com.tbread

import com.tbread.entity.DpsData
import com.tbread.entity.JobClass
import com.tbread.entity.PersonalData
import com.tbread.entity.TargetInfo
import kotlinx.coroutines.Job
import org.slf4j.LoggerFactory
import kotlin.math.log
import kotlin.math.roundToInt

class DpsCalculator(private val dataStorage: DataStorage) {
    private val logger = LoggerFactory.getLogger(DpsCalculator::class.java)

    enum class Mode {
        ALL, BOSS_ONLY
    }

    companion object {
        val POSSIBLE_OFFSETS: IntArray =
            intArrayOf(
                0, 10, 20, 30, 40, 50,
                120, 130, 140, 150,
                230, 240, 250,
                340, 350,
                450,
                1230, 1240, 1250,
                1340, 1350,
                1450,
                2340, 2350,
                2450,
                3450
            )

        val SKILL_MAP = mapOf(
            /*
        치유성
         */
            17010000 to "대지의 응보",
            17020000 to "뇌전",
            17030000 to "방전",
            17040000 to "심판의 번개",
            17050000 to "천벌",
            17040007 to "천벌(1회 추가시전)",
            17080000 to "약화의 낙인",
            17070000 to "고통의 연쇄",
            17150000 to "신성한 기운",
            17150002 to "신성한 기운",
            17090000 to "재생의 빛",
            17350000 to "단죄",
            17100000 to "치유의 빛",
            17120000 to "쾌유의 광휘",
            17120001 to "쾌유의 광휘 MAX",
            17370000 to "벼락 난사",
            17060000 to "벽력",
            17060001 to "벽력 1단계",
            17060002 to "벽력 2단계",
            17060003 to "벽력 MAX",
            17240000 to "충격 해제",
            17320000 to "재생의 축복",
            17280000 to "권능 폭발",
            17290000 to "면죄",
            17160000 to "치유의 기운",
            17430000 to "증폭의 기도",
            17390000 to "소환 부활",
            17400000 to "대지의 징벌",
            17270000 to "구원",
            17190000 to "속박",
            17410000 to "보호의 빛",
            17420000 to "유스티엘의 권능",
            17300000 to "파멸의 목소리",
            17700000 to "강습 낙인",
            17710000 to "따뜻한 가호",
            17720000 to "주신의 가호",
            17730001 to "주신의 은총",
            17730002 to "주신의 은총 (증폭의 기도)",
            17740000 to "치유력 강화",
            17750000 to "불사의 장막",
            17760000 to "회복 차단",
            17770000 to "집중의 기도",
            17780000 to "대지의 은총",
            17790000 to "생존 의지",
            17800000 to "찬란한 가호",

            /*
        검성
         */
            11020000 to "예리한 일격",
            11030000 to "파열의 일격",
            11040000 to "분노의 일격",
            11180000 to "무모한 일격",
            11010000 to "절단의 맹타",
            11420000 to "격파의 맹타",
            11190000 to "도약 찍기",
            11290000 to "유린의검",
            11290001 to "유린의 검",
            11170000 to "내려찍기",
            11440000 to "올려치기",
            11280000 to "검기 난무",
            11200000 to "발목 베기",
            11210000 to "발목 격파",
            11050000 to "분쇄 파동",
            11060000 to "광폭 파동",
            11360000 to "돌진 일격",
            11360001 to "돌진 일격 - Max",
            11300000 to "공중 결박",
            11370000 to "강제 낙하",
            11100000 to "파멸의 맹타",
            11100001 to "파멸의 맹타 - 1단계",
            11100002 to "파멸의 맹타 - Max",
            11260000 to "충격 해제",
            11320000 to "분노 폭발",
            11240000 to "분노의 파동",
            11400000 to "돌격 자세",
            11250000 to "지켈의 축복",
            11110000 to "집중 막기",
            11130000 to "균형의 갑옷",
            11080000 to "칼날 날리기",
            11090000 to "칼날 화무",
            11380000 to "근성",
            11340000 to "흡혈의 검",
            11390000 to "격노 폭발",
            11410000 to "파동의 갑주",
            11430000 to "강제 결박",
            11700000 to "강습 일격",
            11170037 to "내려 찍기",
            11710000 to "생존 자세",
            11720000 to "보호의 갑옷",
            11730000 to "피의 흡수",
            11740000 to "약점 파악",
            11750000 to "공격 준비",
            11760000 to "충격 적중",
            11770000 to "파괴 충동",
            11770007 to "파괴",
            11780000 to "노련한 반격",
            11790000 to "생존 의지",
            11800008 to "살기 파열",

            /*
        정령성
         */
            16010000 to "냉기 충격",
            16020000 to "진공 폭발",
            16030000 to "대지 진동",
            16040000 to "화염 전소",
            16050000 to "재의 부름",
            16100004 to "불의 정령: 도약 찍기",
            16110004 to "물의 정령: 냉기 발산",
            16110005 to "물의 정령: 강화 냉기 발산",
            16140000 to "협공: 저주",
            16001104 to "불의 정령: 화염 폭발",
            16001108 to "물의 정령: 물폭탄",
            16001110 to "바람의 정령: 회오리",
            16001113 to "땅의 정령: 박치기",
            16001117 to "고대의 정령: 파괴",
            16340000 to "연속 난사",
            16130001 to "땅의 정령: 몸통 박치기",
            16130005 to "땅의 정령: 강화 몸통 박치기",
            16330000 to "공간 지배",
            16120002 to "바람의 정령: 낙하 바람",
            16120005 to "바람의 정령: 강화 낙하 바람",
            16070000 to "영혼의 절규",
            16300000 to "원소 융합",
            16300001 to "원소 융합 - 1단계",
            16300002 to "원소 융합 - 2단계",
            16300003 to "원소 융합 - Max",
            16200000 to "충격 해제",
            16210000 to "절망의 저주",
            16710000 to "정령 타격",
            16720000 to "정령 보호",
            16730001 to "정령 강림",
            16740001 to "침식",
            16750000 to "정령 회생",
            16760000 to "정신 집중",
            16800001 to "연속 역류",
            16770000 to "정령 교감",
            16790000 to "회생의 계약",
            16780000 to "원소 결집",
            16240000 to "협공: 파멸의 공세",
            16240001 to "협공: 파멸의 공세 - 1단계",
            16240002 to "협공: 파멸의 공세 - 2단계",
            16240003 to "협공: 파멸의 공세 - Max",
            16001301 to "불의 정령: 운석 소환",
            16001305 to "물의 정령: 빙하 작살",
            16001309 to "바람의 정령: 폭풍",
            16001313 to "땅의 정령: 거대 줄기",
            16001317 to "고대의 정령: 자기 폭풍",
            16190000 to "강화: 정령의 가호",
            16370000 to "불길의 축복",
            16250000 to "소환: 고대의 정령",
            16250001 to "고대의 정령: 영자포",
            16150000 to "협공: 부식",
            16151100 to "불의 정령: 격노 폭발",
            16152100 to "물의 정령: 얼음 사슬",
            16154100 to "바람의 정령: 돌풍",
            16153100 to "땅의 정령: 도발",
            16360000 to "카이시넬의 권능",
            16060000 to "흡인",
            16080000 to "공포의 절규",
            16220000 to "저주의 구름",
            16230000 to "마법 강탈",
            16260000 to "마법 차단",
            16700000 to "강습 공포",
            100055 to "기본공격 (고대 정령)",
            100051 to "기본공격 (고대 정령)",
            100014 to "기본공격 (불의 정령)",
            100024 to "기본공격 (물의 정령)",
            100032 to "기본공격 (바람의 정령)",
            100045 to "기본공격 (땅의 정령)",
            100041 to "기본공격 (땅의 정령)",
            100018 to "기본공격 (불의 정령)",
            100028 to "기본공격 (물의 정령)",


            /*
        호법성
         */
            18010000 to "격파쇄",
            18020000 to "공명쇄",
            18030000 to "벽력쇄",
            18370000 to "폭풍쇄",
            18040000 to "백열격",
            18050000 to "파열격",
            18090000 to "돌진 격파",
            18090001 to "돌진 격파 - 1단계",
            18090002 to "돌진 격파 - 2단계",
            18090003 to "돌진 격파 - MAX",
            18060000 to "타격쇄",
            18070000 to "파산격",
            18100000 to "암격쇄",
            18400000 to "관통쇄",
            18300000 to "질풍 난무",
            18150000 to "열파격",
            18120000 to "쾌유의 주문",
            18210000 to "진동쇄",
            18390000 to "격동쇄",
            18080000 to "파동격",
            18080001 to "파동격",
            18290000 to "회전격",
            18200000 to "충격 해제",
            18410000 to "강격쇄",
            18220000 to "멸화",
            18190000 to "불패의 진언",
            18140000 to "집중 방어",
            18160000 to "질주의 진언",
            18130000 to "분쇄격",
            18330000 to "마르쿠탄의 분노",
            18240000 to "차단의 권능",
            18230000 to "결박의 낙인",
            18170000 to "쾌유의 손길",
            18250000 to "질풍의 권능",
            18420000 to "수호의 축복",
            18700000 to "강습 충격",
            18710000 to "생명의 축복",
            18720000 to "십자 방어",
            18730000 to "보호진",
            18740000 to "고취의 주문",
            18750000 to "공격 준비",
            18760000 to "충격 적중",
            18770000 to "격노의 주문",
            18780000 to "대지의 약속",
            18790000 to "생존 의지",
            18800001 to "바람의 약속",

            /*
        궁성
         */
            14020000 to "저격",
            14030000 to "연사",
            14040000 to "나선 화살",
            14100000 to "질풍 화살",
            14340000 to "속사",
            14130000 to "올가미 화살",
            14140000 to "족쇄 화살",
            14090000 to "표적 화살",
            14050000 to "송곳 화살",
            14330000 to "화살 난사",
            14110000 to "광풍 화살",
            14110001 to "광풍 화살 - 1단계",
            14110002 to "광풍 화살 - 2단계",
            14110003 to "광풍 화살 - Max",
            14170001 to "폭발의 덫",
            14080000 to "파열 화살",
            14070000 to "제압 화살",
            14010000 to "조준 화살",
            14010001 to "조준 화살 - 1단계",
            14010002 to "조준 화살 - 2단계",
            14010003 to "조준 화살 - Max",
            14260000 to "충격 해제",
            14370000 to "번개 화살",
            14720007 to "집중 포화",
            14770007 to "속박의 눈",
            14780008 to "근접 사격",
            14800007 to "사냥꾼의 혼",
            14270000 to "화살 폭풍",
            14120000 to "기습 차기",
            14180000 to "결박의 덫",
            14150000 to "수면 화살",
            14160000 to "봉인 화살",
            14350000 to "대자연의 숨결",
            14060000 to "그리폰 화살",
            14360000 to "폭발 화살",
            14700000 to "강습 강타",
            14200000 to "간파의 눈",

            /*
        마도성
         */
            15210000 to "불꽃 화살",
            15030000 to "작렬",
            15250000 to "열화",
            15090000 to "얼음 사슬",
            15100000 to "냉기 파동",
            15040000 to "불꽃 작살",
            15280002 to "혹한의 바람",
            15050000 to "불꽃 폭발",
            15050007 to "불꽃 폭발 (지연 피해)",
            15010000 to "화염 난사",
            15150000 to "빙결",
            15110000 to "겨울의 속박",
            15330000 to "겨울의 환영",
            15220000 to "빙결 폭발",
            15310000 to "집중의 기원",
            15060000 to "지옥의 화염",
            15060001 to "지옥의 화염 - 1단계",
            15060002 to "지옥의 화염 - 2단계",
            15060003 to "지옥의 화염 - Max",
            15060008 to "지혹의 화염 (화염 지대)",
            15240000 to "충격 해제",
            15340000 to "저주: 고목",
            15710008 to "불의 표식",
            15720000 to "대지의 로브",
            15730007 to "냉기 소환",
            15740000 to "불꽃의 로브",
            15760000 to "정기 흡수",
            15770000 to "저항의 은혜",
            15750000 to "냉기의 로브",
            15780000 to "강화의 은혜",
            15790000 to "회생의 계약",
            15800007 to "생기 증발",
            15360000 to "신성 폭발",
            15160000 to "강철 보호막",
            15400000 to "원소 강화",
            15140000 to "저주: 나무",
            15230000 to "빙설의 갑주",
            15130000 to "영혼 동결",
            15200000 to "냉기 폭풍",
            15390000 to "불의 장벽",
            15300000 to "루미엘의 공간",
            15300001 to "나락",
            15320007 to "지연 폭발",
            15120000 to "빙하 강타",
            15700000 to "강습 폭격",

            /*
        수호성
         */
            12010000 to "맹렬한 일격",
            12020000 to "회심의 일격",
            12030000 to "필사의 일격",
            12440000 to "위협의 맹타",
            12040000 to "연속 난타",
            12060000 to "응징의 일격",
            12060005 to "응징의 일격 (추가 시전)",
            12130000 to "포획",
            12100000 to "방패 강타",
            12240000 to "심판",
            12340000 to "섬광 난무",
            12270000 to "쇠약의 맹타",
            12350000 to "비호의 일격",
            12430000 to "방패 돌격",
            12430001 to "방패 돌격 - Max",
            12300000 to "섬멸",
            12090000 to "징벌",
            12090001 to "징벌 - 1단계",
            12090002 to "징벌 - 2단계",
            12090003 to "징벌 - Max",
            12260000 to "충격 해제",
            12330000 to "생포",
            12710000 to "체력 강화",
            12720000 to "비호의 방패",
            12730001 to "단죄의 가호",
            12740000 to "철벽 방어",
            12750000 to "수호의 인장",
            12760000 to "충격 적중",
            12770000 to "모욕의 포효",
            12780000 to "격앙",
            12790000 to "생존 의지",
            12800000 to "고통 차단",
            12310000 to "주신의 징벌",
            12320000 to "네자칸의 방패",
            12110000 to "보호의 방패",
            12120000 to "도발",
            12200000 to "균형의 갑옷",
            12190000 to "이중 갑옷",
            12070000 to "파멸의 방패",
            12230000 to "고결의 갑주",
            12410000 to "처형의 검",
            12250000 to "전우 보호",
            12220000 to "나포",
            12420000 to "검풍",
            12700000 to "강습 맹격",

            /*
        살성
         */
            13010000 to "빠른 베기",
            13030000 to "절혼 베기",
            13040000 to "쾌속 베기",
            13100000 to "맹수의 포효",
            13110000 to "맹수의 뒷발차기",
            13120000 to "맹수의 후려치기",
            13070000 to "암습",
            13060000 to "기습",
            13350000 to "심장 찌르기",
            13340000 to "폭풍 난무",
            13210000 to "회오리 베기",
            13050000 to "섬광 베기",
            13360000 to "침투",
            13380000 to "암격",
            13220000 to "그림자 낙하",
            13130000 to "문양 폭발",
            13260000 to "충격 해제",
            13330000 to "폭풍 베기",
            13710000 to "육감 극대화",
            13720000 to "빈틈 노리기",
            13720005 to "분신 공격",
            13720006 to "분신 공격",
            13720007 to "분신 공격",
            13720008 to "분신 공격",
            13720009 to "분신 공격",
            13730000 to "독 바르기",
            13730007 to "중독",
            13740000 to "배후 강타",
            13750000 to "강습 자세",
            13760000 to "충격 적중",
            13770000 to "기습 자세",
            13780000 to "방어 균열",
            13790000 to "회생의 계약",
            13800007 to "각오",
            13270000 to "맹수의 송곳니",
            13390000 to "신속의 계약",
            13250000 to "연막탄",
            13080000 to "회피 자세",
            13280000 to "나선 베기",
            13180000 to "그림자 보행",
            13020000 to "암검 투척",
            13090000 to "암검 추적",
            13300000 to "트리니엘의 비수",
            13230000 to "공중 포박",
            13240000 to "공중 살법",
            13310000 to "환영 분신",
            13370000 to "회피의 계약",
            13700000 to "강습 습격"

        )

        val SKILL_CODES: IntArray =
            intArrayOf(
                100051,
                100055,
                17010000,
                17020000,
                17030000,
                17040000,
                17040007,
                17050000,
                17080000,
                17070000,
                17150002,
                17090000,
                17350000,
                17100000,
                17120000,
                17120001,
                17370000,
                17060000,
                17060001,
                17060002,
                17060003,
                17240000,
                17320000,
                17280000,
                17290000,
                17160000,
                17430000,
                17390000,
                17400000,
                17270000,
                17190000,
                17410000,
                17420000,
                17300000,
                17700000,
                17710000,
                17720000,
                17730001,
                17730002,
                17740000,
                17750000,
                17760000,
                17770000,
                17780000,
                17790000,
                17800000,
                11020000,
                11030000,
                11040000,
                11180000,
                11010000,
                11420000,
                11190000,
                11290000,
                11290001,
                11170000,
                11440000,
                11280000,
                11200000,
                11210000,
                11050000,
                11060000,
                11360000,
                11360001,
                11300000,
                11370000,
                11100000,
                11100001,
                11100002,
                11260000,
                11320000,
                11240000,
                11400000,
                11250000,
                11110000,
                11130000,
                11080000,
                11090000,
                11380000,
                11340000,
                11390000,
                11410000,
                11430000,
                11700000,
                11170037,
                11710000,
                11720000,
                11730000,
                11740000,
                11750000,
                11760000,
                11770000,
                11770007,
                11780000,
                11790000,
                11800008,
                16010000,
                16020000,
                16030000,
                16040000,
                16050000,
                16100004,
                16110004,
                16110005,
                16140000,
                16001104,
                16001108,
                16001110,
                16001113,
                16001117,
                16340000,
                16130001,
                16130005,
                16330000,
                16120002,
                16120005,
                16070000,
                16300000,
                16300001,
                16300002,
                16300003,
                16200000,
                16210000,
                16710000,
                16720000,
                16730001,
                16740001,
                16750000,
                16760000,
                16800001,
                16770000,
                16790000,
                16780000,
                16240000,
                16240001,
                16240002,
                16240003,
                16001301,
                16001305,
                16001309,
                16001313,
                16001317,
                16190000,
                16370000,
                16250000,
                16250001,
                16150000,
                16151100,
                16152100,
                16154100,
                16153100,
                16360000,
                16060000,
                16080000,
                16220000,
                16230000,
                16260000,
                16700000,
                18010000,
                18020000,
                18030000,
                18370000,
                18040000,
                18050000,
                18090000,
                18090001,
                18090002,
                18090003,
                18060000,
                18070000,
                18100000,
                18400000,
                18300000,
                18150000,
                18120000,
                18210000,
                18390000,
                18080000,
                18080001,
                18290000,
                18200000,
                18410000,
                18220000,
                18190000,
                18140000,
                18160000,
                18130000,
                18330000,
                18240000,
                18230000,
                18170000,
                18250000,
                18420000,
                18700000,
                18710000,
                18720000,
                18730000,
                18740000,
                18750000,
                18760000,
                18770000,
                18780000,
                18790000,
                18800001,
                14020000,
                14030000,
                14040000,
                14100000,
                14340000,
                14130000,
                14140000,
                14090000,
                14050000,
                14330000,
                14110000,
                14110001,
                14110002,
                14110003,
                14170001,
                14080000,
                14070000,
                14010000,
                14010001,
                14010002,
                14010003,
                14260000,
                14370000,
                14720007,
                14770007,
                14780008,
                14800007,
                14270000,
                14120000,
                14180000,
                14150000,
                14160000,
                14350000,
                14060000,
                14360000,
                14700000,
                14200000,
                15210000,
                15030000,
                15250000,
                15090000,
                15100000,
                15040000,
                15280002,
                15050000,
                15050007,
                15010000,
                15150000,
                15110000,
                15330000,
                15220000,
                15310000,
                15060000,
                15060001,
                15060002,
                15060003,
                15060008,
                15240000,
                15340000,
                15710008,
                15720000,
                15730007,
                15740000,
                15760000,
                15770000,
                15750000,
                15780000,
                15790000,
                15800007,
                15360000,
                15160000,
                15400000,
                15140000,
                15230000,
                15130000,
                15200000,
                15390000,
                15300000,
                15300001,
                15320007,
                15120000,
                15700000,
                12010000,
                12020000,
                12030000,
                12440000,
                12040000,
                12060000,
                12060005,
                12130000,
                12100000,
                12240000,
                12340000,
                12270000,
                12350000,
                12430000,
                12430001,
                12300000,
                12090000,
                12090001,
                12090002,
                12090003,
                12260000,
                12330000,
                12710000,
                12720000,
                12730001,
                12740000,
                12750000,
                12760000,
                12770000,
                12780000,
                12790000,
                12800000,
                12310000,
                12320000,
                12110000,
                12120000,
                12200000,
                12190000,
                12070000,
                12230000,
                12410000,
                12250000,
                12220000,
                12420000,
                12700000,
                13010000,
                13030000,
                13040000,
                13100000,
                13110000,
                13120000,
                13070000,
                13060000,
                13350000,
                13340000,
                13210000,
                13050000,
                13360000,
                13380000,
                13220000,
                13130000,
                13260000,
                13330000,
                13710000,
                13720000,
                13720005,
                13720006,
                13720007,
                13720008,
                13720009,
                13730000,
                13730007,
                13740000,
                13750000,
                13760000,
                13770000,
                13780000,
                13790000,
                13800007,
                13270000,
                13390000,
                13250000,
                13080000,
                13280000,
                13180000,
                13020000,
                13090000,
                13300000,
                13230000,
                13240000,
                13310000,
                13370000,
                13700000
            ).apply { sort() }
    }

    private val targetInfoMap = hashMapOf<Int, TargetInfo>()

    private var mode: Mode = Mode.BOSS_ONLY
    private var currentTarget: Int = 0

    fun setMode(mode: Mode) {
        this.mode = mode
        //모드 변경시 이전기록 초기화?
    }

    fun getDps(): DpsData {
        val pdpMap = dataStorage.getBossModeData()

        pdpMap.forEach { (target, data) ->
            var flag = false
            var targetInfo = targetInfoMap[target]
            if (!targetInfoMap.containsKey(target)) {
                flag = true
            }
            data.forEach { pdp ->
                if (flag) {
                    flag = false
                    targetInfo = TargetInfo(target, 0, pdp.getTimeStamp(), pdp.getTimeStamp())
                    targetInfoMap[target] = targetInfo!!
                }
                targetInfo!!.processPdp(pdp)
                //그냥 아래에서 재계산하는거 여기서 해놓고 아래에선 그냥 골라서 주는게 맞는거같은데 나중에 고민할필요있을듯
            }
        }
        val dpsData = DpsData()
        val targetData = decideTarget()
        dpsData.targetName = targetData.second
        val battleTime = targetInfoMap[currentTarget]?.parseBattleTime() ?: 0
        val nicknameData = dataStorage.getNickname()
        var totalDamage = 0.0
        if (battleTime == 0L) {
            return dpsData
        }
        pdpMap[currentTarget]!!.forEach lastPdpLoop@{ pdp ->
            totalDamage += pdp.getDamage()
            val uid = dataStorage.getSummonData()[pdp.getActorId()] ?: pdp.getActorId()
            val nickname:String = nicknameData[uid]
                ?: nicknameData[dataStorage.getSummonData()[uid]?:uid]
                ?: uid.toString()
            if (!dpsData.map.containsKey(uid)) {
                dpsData.map[uid] = PersonalData(nickname = nickname)
            }
            pdp.setSkillCode(inferOriginalSkillCode(pdp.getSkillCode1()) ?: pdp.getSkillCode1())
            dpsData.map[uid]!!.processPdp(pdp)
            if (dpsData.map[uid]!!.job == "") {
                val origSkillCode = inferOriginalSkillCode(pdp.getSkillCode1()) ?: -1
                val job = JobClass.convertFromSkill(origSkillCode)
                if (job != null) {
                    dpsData.map[uid]!!.job = job.className
                }
            }
        }
        dpsData.map.forEach { (key, data) ->
            if (dataStorage.getSummonData().containsKey(key)){
                dataStorage.getSummonData().remove(key)
            }
            data.dps = data.amount / battleTime * 1000
            data.damageContribution = data.amount / totalDamage * 100
        }
        return dpsData
    }

    private fun decideTarget(): Pair<Int, String> {
        val target: Int = targetInfoMap.maxByOrNull { it.value.damagedAmount() }?.key ?: 0
        var targetName = ""
        currentTarget = target
        //데미지 누계말고도 건수누적방식도 추가하는게 좋을지도? 지금방식은 정복같은데선 타겟변경에 너무 오랜시간이듬
        if (dataStorage.getMobData().containsKey(target)) {
            val mobCode = dataStorage.getMobData()[target]
            if (dataStorage.getMobCodeData().containsKey(mobCode)) {
                targetName = dataStorage.getMobCodeData()[mobCode]!!
            }
        }

        return Pair(target, targetName)
    }

    private fun inferOriginalSkillCode(skillCode: Int): Int? {
        for (offset in POSSIBLE_OFFSETS) {
            val possibleOrigin = skillCode - offset
            if (SKILL_CODES.binarySearch(possibleOrigin) >= 0) {
                logger.debug("추론 성공한 원본 스킬코드 :{}", possibleOrigin)
                return possibleOrigin
            }
        }
        logger.debug("스킬코드 추론 실패")
        return null
    }

    fun resetDataStorage() {
        dataStorage.flushDamageStorage()
        targetInfoMap.clear()
        logger.info("대상 데미지 누적 데이터 초기화 완료")
    }

    fun analyzingData(uid: Int) {
        val dpsData = getDps()
        dpsData.map.forEach { (_, pData) ->
            logger.info("-----------------------------------------")
            logger.info(
                "닉네임: {} 직업: {} 총 딜량: {} 기여도: {}",
                pData.nickname,
                pData.job,
                pData.amount,
                pData.damageContribution
            )
            pData.analyzedData.forEach { (key, data) ->
                logger.info("스킬(코드): {} 스킬 총 피해량: {}", SKILL_MAP[key] ?: key, data.damageAmount)
                logger.info(
                    "사용 횟수: {} 치명타 횟수: {} 치명타 비율:{}",
                    data.times,
                    data.critTimes,
                    data.critTimes / data.times * 100
                )
                logger.info("스킬의 딜 지분: {}%", (data.damageAmount / pData.amount * 100).roundToInt())
            }
            logger.info("-----------------------------------------")
        }
    }

}